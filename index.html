<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å±•å°ARï¼šæ‰«æ+æ‰‹åŠ¿äº¤äº’</title>

    <!-- 1. A-Frame æ¡†æ¶ -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- 2. MindAR (ç”¨äºå›¾åƒè¿½è¸ª) -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <!-- 3. MediaPipe (ç”¨äºæ‰‹åŠ¿è¯†åˆ«) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        
        /* UI å±‚ */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #status-bar {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-family: sans-serif;
            border: 1px solid rgba(255,255,255,0.3);
            text-align: center;
        }

        #scan-guide {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 70vw; height: 70vw;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /* é®ç½©æ•ˆæœ */
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="status-bar">åˆå§‹åŒ– AR å¼•æ“...</div>
        <div id="scan-guide">
            <div style="text-align:center; color:white; margin-top:110%;">è¯·æ‰«æè¯†åˆ«å›¾</div>
        </div>
    </div>

    <!-- 
      MindAR åœºæ™¯é…ç½® 
      imageTargetSrc: è¿™é‡Œæ˜¯è¯†åˆ«å›¾çš„ç¼–è¯‘æ–‡ä»¶ (.mind)ã€‚
      é»˜è®¤ä½¿ç”¨ MindAR å®˜æ–¹ç¤ºä¾‹å¡ç‰‡ã€‚
    -->
    <a-scene 
        mindar-image="imageTargetSrc: ./card.mind; uiScanning: no;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- å›¾åƒè¯†åˆ«ç›®æ ‡ (targetIndex: 0 ä»£è¡¨ç¬¬ä¸€ä¸ªè¯†åˆ«å›¾) -->
        <a-entity id="target-entity" mindar-image-target="targetIndex: 0">
            
            <!-- è¿™é‡Œæ”¾ä½ çš„æ¨¡å‹ -->
            <!-- ä½¿ç”¨ glb æ¨¡å‹ï¼Œå¹¶è®¾ç½®åˆå§‹å¤§å°å’Œä½ç½® -->
            <a-gltf-model 
                id="ar-model" 
                rotation="0 0 0" 
                position="0 0 0" 
                scale="0.5 0.5 0.5" 
                src="./DamagedHelmet.glb"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear; enabled: false"> <!-- é»˜è®¤ä¸æ—‹è½¬ï¼Œæåˆæ—¶æˆ‘ä»¬æ‰‹åŠ¨æ§åˆ¶ -->
            </a-gltf-model>

        </a-entity>
    </a-scene>

<script>
    const statusBar = document.getElementById('status-bar');
    const scanGuide = document.getElementById('scan-guide');
    const sceneEl = document.querySelector('a-scene');
    const arModel = document.getElementById('ar-model');
    const targetEntity = document.getElementById('target-entity');

    let isModelVisible = false;
    let isPinching = false;
    
    // å¹³æ»‘å‚æ•°
    let targetScale = 0.5;
    let currentScale = 0.5;
    let lastPinchDist = 0;

    // === 1. ç›‘å¬ AR äº‹ä»¶ ===
    
    // å½“è¯†åˆ«åˆ°ç‰©ä½“æ—¶
    targetEntity.addEventListener("targetFound", event => {
        console.log("è¯†åˆ«æˆåŠŸï¼");
        statusBar.innerText = "è¯†åˆ«æˆåŠŸï¼ğŸ– è¯·æåˆæ‰‹æŒ‡æ§åˆ¶æ¨¡å‹";
        scanGuide.classList.add('hidden'); // éšè—æ‰«ææ¡†
        isModelVisible = true;
    });

    // å½“ä¸¢å¤±ç‰©ä½“æ—¶
    targetEntity.addEventListener("targetLost", event => {
        console.log("ç›®æ ‡ä¸¢å¤±");
        statusBar.innerText = "è¯·å¯¹å‡†è¯†åˆ«ç‰©ä½“";
        scanGuide.classList.remove('hidden');
        isModelVisible = false;
    });

    // === 2. MediaPipe åˆå§‹åŒ– ===
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 0, // è®¾ä¸º0ä»¥æé«˜æ€§èƒ½ï¼Œå› ä¸ºåŒæ—¶è¿è¡ŒARå¾ˆåƒèµ„æº
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults(onResults);

    // === 3. å…³é”®ï¼šè¿æ¥ MindAR è§†é¢‘æµä¸ MediaPipe ===
    sceneEl.addEventListener("arReady", (event) => {
        console.log("AR ç³»ç»Ÿå°±ç»ª");
        statusBar.innerText = "æ­£åœ¨å¯åŠ¨ AI æ‰‹åŠ¿è¯†åˆ«...";
        
        // MindAR ä¼šåˆ›å»ºä¸€ä¸ª video æ ‡ç­¾ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å®ƒ
        const videoElement = document.querySelector('video');
        
        if (videoElement) {
            // å¼€å§‹å¾ªç¯æ£€æµ‹
            startDetectionLoop(videoElement);
        } else {
            console.error("æœªæ‰¾åˆ° Video å…ƒç´ ");
        }
    });

    async function startDetectionLoop(video) {
        async function frame() {
            // åªæœ‰å½“è§†é¢‘åœ¨æ’­æ”¾ä¸”æ¨¡å‹å¯è§æ—¶ï¼Œæ‰è¿›è¡Œç¹é‡çš„ AI è®¡ç®—
            if (video.readyState >= 2 && isModelVisible) {
                await hands.send({image: video});
            }
            requestAnimationFrame(frame);
        }
        frame();
    }

    // === 4. æ‰‹åŠ¿äº¤äº’é€»è¾‘ ===
    function onResults(results) {
        if (!isModelVisible) return; // å¦‚æœæ¨¡å‹æ²¡å‡ºæ¥ï¼Œä¸å¤„ç†æ‰‹åŠ¿

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            const thumb = landmarks[4];
            const index = landmarks[8];

            // è®¡ç®—æåˆè·ç¦»
            const dist = Math.hypot(thumb.x - index.x, thumb.y - index.y);

            // æåˆåˆ¤æ–­é˜ˆå€¼
            if (dist < 0.08) {
                if (!isPinching) {
                    // åˆšå¼€å§‹æåˆï¼Œè®°å½•åˆå§‹çŠ¶æ€ï¼Œé˜²æ­¢è·³å˜
                    isPinching = true;
                    statusBar.innerText = "âœŠ äº¤äº’ä¸­ (æ—‹è½¬/ç¼©æ”¾)";
                    statusBar.style.color = "#FFD700";
                }

                // --- äº¤äº’é€»è¾‘ A: æ—‹è½¬æ¨¡å‹ ---
                // æ ¹æ®é£ŸæŒ‡çš„ X åæ ‡ç§»åŠ¨æ¥æ—‹è½¬æ¨¡å‹
                // ç®€å•çš„æ˜ å°„ï¼šæ‰‹æŒ‡åœ¨å±å¹•å·¦è¾¹ -> å‘å·¦è½¬ï¼Œæ‰‹æŒ‡åœ¨å³è¾¹ -> å‘å³è½¬
                const rotationY = (index.x - 0.5) * 180; // -90 åˆ° 90 åº¦
                
                // --- äº¤äº’é€»è¾‘ B: ç¼©æ”¾æ¨¡å‹ (åŸºäºæ‰‹æŒå¤§å°æˆ–æåˆæ·±åº¦) ---
                // è¿™é‡Œæ¼”ç¤ºï¼šæ ¹æ®æ‰‹åœ¨å±å¹•ä¸Šçš„é«˜åº¦(y)æ¥æ§åˆ¶ç¼©æ”¾ (ä¸Šæ»‘æ”¾å¤§ï¼Œä¸‹æ»‘ç¼©å°)
                const scaleFactor = (1 - index.y) + 0.2; // 0.2 ~ 1.2
                
                // å¹³æ»‘å¤„ç†
                const object3D = arModel.object3D;
                
                // æ—‹è½¬å¹³æ»‘
                object3D.rotation.y += (THREE.MathUtils.degToRad(rotationY) - object3D.rotation.y) * 0.1;
                
                // ç¼©æ”¾å¹³æ»‘
                targetScale = scaleFactor;
                currentScale = currentScale * 0.9 + targetScale * 0.1;
                object3D.scale.set(currentScale, currentScale, currentScale);

            } else {
                isPinching = false;
                statusBar.innerText = "ğŸ– è¯†åˆ«æˆåŠŸ (æåˆä»¥æ§åˆ¶)";
                statusBar.style.color = "#FFF";
            }
        }
    }

</script>
</body>
</html>