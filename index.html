<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç©ºé—´ AR - è°ƒè¯•ä¿®å¤ç‰ˆ</title>

    <!-- 0. å¼•å…¥ vConsoleï¼šæ‰‹æœºå³ä¸‹è§’ä¼šå‡ºç°ç»¿è‰²æŒ‰é’®ï¼Œç”¨äºçœ‹æŠ¥é”™ -->
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // åˆå§‹åŒ–è°ƒè¯•å™¨
        var vConsole = new VConsole();
        console.log("vConsole å·²å¯åŠ¨ï¼Œç¯å¢ƒæ£€æµ‹ä¸­...");
    </script>

    <!-- 1. Three.js é…ç½® -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <!-- 2. MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #bg-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; }
        #three-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* å¯åŠ¨å±‚ */
        #start-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        #enter-btn {
            margin-top: 30px; padding: 15px 40px; border-radius: 50px;
            background: #007aff; color: white; font-size: 18px; border: none;
            box-shadow: 0 4px 12px rgba(0,122,255,0.5);
        }
        #error-log {
            margin-top: 20px; color: #ff4444; font-size: 12px; padding: 0 20px; text-align: center;
        }
        #input-canvas { display: none; }
        #status-bar { position: fixed; top: 20px; width: 100%; text-align: center; color: yellow; z-index: 100; text-shadow: 1px 1px 2px black; }
    </style>
</head>
<body>

    <div id="start-layer">
        <h2>ğŸ›ï¸ ç©ºé—´æ–‡ç‰©å±•ç¤º</h2>
        <div id="error-log">ç­‰å¾…æ“ä½œ...</div>
        <button id="enter-btn">ç‚¹å‡»è¿›å…¥ä½“éªŒ</button>
    </div>

    <div id="status-bar"></div>
    <video id="bg-video" playsinline webkit-playsinline muted autoplay></video>
    <canvas id="input-canvas"></canvas>
    <canvas id="three-canvas"></canvas>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { DeviceOrientationControls } from 'three/addons/controls/DeviceOrientationControls.js';

    const btn = document.getElementById('enter-btn');
    const errLog = document.getElementById('error-log');
    const startLayer = document.getElementById('start-layer');
    const videoEl = document.getElementById('bg-video');
    const inputCanvas = document.getElementById('input-canvas');
    const ctx = inputCanvas.getContext('2d');
    const statusBar = document.getElementById('status-bar');

    let scene, camera, renderer, model, controls;
    let isRunning = false;
    let hands;

    // === ç‚¹å‡»äº‹ä»¶ ===
    btn.addEventListener('click', async () => {
        errLog.innerText = "æ­£åœ¨åˆå§‹åŒ–...";
        
        try {
            // 1. æ£€æŸ¥ HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                throw new Error("å¿…é¡»ä½¿ç”¨ HTTPS åè®®ï¼Œå¦åˆ™æ— æ³•è°ƒç”¨ä¼ æ„Ÿå™¨ï¼");
            }

            // 2. è¯·æ±‚é™€èºä»ªæƒé™ (iOS æ ¸å¿ƒæ­¥éª¤)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                const permission = await DeviceOrientationEvent.requestPermission();
                if (permission !== 'granted') {
                    throw new Error("é™€èºä»ªæƒé™è¢«æ‹’ç»ï¼Œæ— æ³•ä½¿ç”¨ç©ºé—´å®šä½");
                }
            }

            // 3. å¯åŠ¨æ‘„åƒå¤´
            errLog.innerText = "æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...";
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            });
            videoEl.srcObject = stream;
            
            // ç­‰å¾…è§†é¢‘æµçœŸæ­£å¼€å§‹
            await new Promise((resolve) => {
                videoEl.onloadedmetadata = () => {
                    videoEl.play();
                    resolve();
                };
            });

            // 4. å…¨éƒ¨æˆåŠŸï¼Œéšè—å¯åŠ¨é¡µ
            startLayer.style.display = 'none';
            statusBar.innerText = "æ­£åœ¨åŠ è½½ 3D åœºæ™¯...";
            
            // 5. åˆå§‹åŒ– 3D å’Œ AI
            initThree();
            initAI();
            isRunning = true;

        } catch (e) {
            console.error(e);
            alert("å¯åŠ¨å¤±è´¥: " + e.message); // å¼¹çª—æŠ¥é”™
            errLog.innerText = e.message;
        }
    });

    // === Three.js é€»è¾‘ ===
    function initThree() {
        try {
            scene = new THREE.Scene();
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            const dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
            dirLight.position.set(0, 5, 5);
            scene.add(ambientLight);
            scene.add(dirLight);

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 100);
            
            // ç»‘å®šé™€èºä»ªæ§åˆ¶
            controls = new DeviceOrientationControls(camera);

            renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById('three-canvas'),
                alpha: true,
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);

            // åŠ è½½æ¨¡å‹
            const loader = new GLTFLoader();
            const modelUrl = './DamagedHelmet.glb';
            
            loader.load(modelUrl, (gltf) => {
                model = gltf.scene;
                // æ”¾åœ¨æ­£å‰æ–¹ 3 ç±³å¤„
                model.position.set(0, 0, -3); 
                model.scale.set(1, 1, 1);
                scene.add(model);
                statusBar.innerText = "åŠ è½½å®Œæˆï¼è½¬åŠ¨æ‰‹æœºæŸ¥çœ‹æ–‡ç‰©";
            }, 
            (xhr) => { console.log((xhr.loaded / xhr.total * 100) + '% loaded'); },
            (error) => { console.error(error); statusBar.innerText = "æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"; }
            );

            animate();
        } catch(e) {
            console.error("ThreeJS Init Error:", e);
            alert("3D å¼•æ“åˆå§‹åŒ–å¤±è´¥");
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        if(controls) controls.update();
        if(renderer && scene && camera) renderer.render(scene, camera);
    }

    // === MediaPipe æ‰‹åŠ¿é€»è¾‘ ===
    function initAI() {
        try {
            hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            hands.onResults(onResults);
            
            // å¯åŠ¨å¾ªç¯
            startAILoop();
        } catch (e) {
            console.error("AI Init Error:", e);
        }
    }

    // AI èŠ‚æµå¾ªç¯
    let lastTime = 0;
    function startAILoop() {
        const loop = (time) => {
            if (isRunning && videoEl.videoWidth > 0 && time - lastTime > 66) { // ~15 FPS
                lastTime = time;
                if (inputCanvas.width !== videoEl.videoWidth) {
                    inputCanvas.width = videoEl.videoWidth;
                    inputCanvas.height = videoEl.videoHeight;
                }
                ctx.drawImage(videoEl, 0, 0);
                hands.send({image: inputCanvas}).catch(e => console.error(e));
            }
            requestAnimationFrame(loop);
        };
        loop(0);
    }

    function onResults(results) {
        // ç®€å•äº¤äº’æ¼”ç¤º
        if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            const dist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
            
            if(dist < 0.08 && model) {
                statusBar.innerText = "âœŠ æåˆæ—‹è½¬ä¸­";
                statusBar.style.color = "yellow";
                model.rotation.y += 0.05;
            } else {
                statusBar.innerText = "ğŸ– å‘ç°æ‰‹éƒ¨";
                statusBar.style.color = "#0f0";
            }
        }
    }

    // çª—å£è°ƒæ•´
    window.addEventListener('resize', () => {
        if(camera && renderer) {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    });
</script>
</body>
</html>