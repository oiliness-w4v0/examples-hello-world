<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR å±•å° - å®‰å“ä¼˜åŒ–ç‰ˆ</title>

    <!-- 1. æ ¸å¿ƒåº“ -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        
        /* === åŠ è½½å±‚ (Loading) === */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #00ff88;
            animation: spin 1s ease-in-out infinite;
        }
        .loading-text {
            color: white; margin-top: 20px; font-size: 16px; letter-spacing: 1px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* === çŠ¶æ€ UI === */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }
        #status-pill {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6); color: #fff;
            padding: 8px 24px; border-radius: 30px;
            font-size: 14px; border: 1px solid rgba(255,255,255,0.2);
            white-space: nowrap;
        }
        
        /* æ‰«ææ¡† */
        #scan-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60vw; height: 60vw;
            border: 2px dashed rgba(255, 255, 255, 0.5); border-radius: 12px;
            box-shadow: 0 0 0 2000px rgba(0,0,0,0.5); /* é»‘è‰²é®ç½© */
        }
        
        .hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <!-- Loading é®ç½© -->
    <div id="loader-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-msg">å¯åŠ¨ AR å¼•æ“...</div>
    </div>

    <!-- UI å±‚ -->
    <div id="ui-layer">
        <div id="status-pill" class="hidden">è¯·æ‰«æè¯†åˆ«å›¾</div>
        <div id="scan-box"></div>
    </div>

    <!-- MindAR åœºæ™¯ -->
    <a-scene 
        mindar-image="imageTargetSrc: ./card2.mind; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- è¯†åˆ«ç›®æ ‡ -->
        <a-entity id="target-entity" mindar-image-target="targetIndex: 0">
            <!-- æ¨¡å‹åŒ…è£¹å±‚ -->
            <a-entity id="model-wrapper" position="0 0 0" scale="0.5 0.5 0.5">
                <a-gltf-model 
                    src="./DamagedHelmet.glb"
                    position="0 0 0" rotation="90 0 0">
                </a-gltf-model>
            </a-entity>
        </a-entity>
    </a-scene>

<script>
    // === æ ¸å¿ƒé…ç½® ===
    const CONFIG = {
        detectFPS: 15,       // [å…³é”®] Android ä¼˜åŒ–æ ¸å¿ƒï¼šé™åˆ¶æ‰‹åŠ¿è¯†åˆ«å¸§ç‡ï¼Œç»™ AR ç•™å‡ºç®—åŠ›
        smoothSpeed: 0.15,   // å¹³æ»‘ç³»æ•°
        moveSensitivity: 2.5 // äº¤äº’çµæ•åº¦
    };

    // DOM å…ƒç´ 
    const loaderOverlay = document.getElementById('loader-overlay');
    const loadingMsg = document.getElementById('loading-msg');
    const statusPill = document.getElementById('status-pill');
    const scanBox = document.getElementById('scan-box');
    const modelWrapper = document.getElementById('model-wrapper');
    const sceneEl = document.querySelector('a-scene');

    // çŠ¶æ€
    let isArReady = false;
    let isTargetFound = false;
    let isPinching = false;
    
    // äº¤äº’å˜é‡
    let startPinch = { x: 0, y: 0 };
    let initialModel = { scale: 0.5, rotateY: 0 };
    let targetModel = { scale: 0.5, rotateY: 0 };
    let currentModel = { scale: 0.5, rotateY: 0 };

    // === 1. åˆå§‹åŒ–æµç¨‹ ===
    
    // ç›‘å¬ AR å‡†å¤‡å°±ç»ª
    sceneEl.addEventListener("arReady", () => {
        isArReady = true;
        loadingMsg.innerText = "æ­£åœ¨åŠ è½½ AI æ¨¡å‹...";
        setupMediaPipe(); // AR è§†é¢‘æµå‡†å¤‡å¥½åï¼Œæ‰åŠ è½½ MediaPipe
    });

    // ç›‘å¬è¯†åˆ«äº‹ä»¶
    const targetEntity = document.getElementById('target-entity');
    targetEntity.addEventListener("targetFound", () => {
        isTargetFound = true;
        scanBox.classList.add('hidden');
        statusPill.classList.remove('hidden');
        statusPill.innerText = "è¯†åˆ«æˆåŠŸï¼ğŸ– æåˆæ‰‹æŒ‡æ§åˆ¶";
        statusPill.style.color = "#00ff88";
    });
    targetEntity.addEventListener("targetLost", () => {
        isTargetFound = false;
        scanBox.classList.remove('hidden');
        statusPill.innerText = "è¯·å¯¹å‡†è¯†åˆ«å›¾";
        statusPill.style.color = "#fff";
        isPinching = false;
    });

    // === 2. MediaPipe è®¾ç½® (Android å…¼å®¹æ€§ä¿®æ­£) ===
    function setupMediaPipe() {
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 0, // 0 = æœ€å¿«/ç²¾åº¦æœ€ä½ (Android å¿…é¡»é€‰è¿™ä¸ª)
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onHandResults);

        // å¯åŠ¨å®‰å…¨æ£€æŸ¥å¾ªç¯ï¼Œå¯»æ‰¾è§†é¢‘æµ
        waitForVideoReady(hands);
    }

    // [å…³é”®ä¿®å¤]ï¼šç­‰å¾…è§†é¢‘æµå®Œå…¨å‡†å¤‡å¥½
    function waitForVideoReady(hands) {
        const video = document.querySelector('video');
        
        // æ£€æŸ¥è§†é¢‘æ˜¯å¦å­˜åœ¨ï¼Œä¸”æœ‰å®½åº¦ï¼ˆè¯´æ˜å·²è§£ç ç¬¬ä¸€å¸§ï¼‰
        if (video && video.readyState >= 2 && video.videoWidth > 0) {
            loadingMsg.innerText = "å¯åŠ¨å®Œæˆ";
            
            // å»¶è¿Ÿä¸€ç‚¹ç‚¹è®© UI æ¶ˆå¤±æ›´è‡ªç„¶
            setTimeout(() => {
                loaderOverlay.style.opacity = '0';
                setTimeout(() => loaderOverlay.style.display = 'none', 500);
                statusPill.classList.remove('hidden');
            }, 1000);

            // å¯åŠ¨ AI å¾ªç¯
            startThrottledLoop(video, hands);
        } else {
            // å¦‚æœæ²¡å‡†å¤‡å¥½ï¼Œç»§ç»­ç­‰
            requestAnimationFrame(() => waitForVideoReady(hands));
        }
    }

    // [å…³é”®ä¿®å¤]ï¼šèŠ‚æµå¾ªç¯ (Throttle)
    function startThrottledLoop(video, hands) {
        let lastTime = 0;
        const interval = 1000 / CONFIG.detectFPS; // è®¡ç®—æ¯å¸§æœ€å°é—´éš”

        async function loop(timestamp) {
            // åªæœ‰å½“æ—¶é—´é—´éš”è¶³å¤Ÿï¼Œä¸”è¯†åˆ«å›¾è¢«æ‰¾åˆ°æ—¶ï¼Œæ‰è·‘ AI
            // è¿™æ · Android å°±ä¸ä¼šå¡æ­»
            if (timestamp - lastTime >= interval && isTargetFound) {
                lastTime = timestamp;
                try {
                    await hands.send({image: video});
                } catch (e) {
                    console.error("AI Error:", e);
                }
            }
            requestAnimationFrame(loop);
        }
        loop(0);
    }

    // === 3. æ‰‹åŠ¿é€»è¾‘å¤„ç† ===
    function onHandResults(results) {
        if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
            isPinching = false;
            return;
        }

        const lm = results.multiHandLandmarks[0];
        const thumb = lm[4];
        const index = lm[8];

        // æåˆè·ç¦»
        const dist = Math.hypot(thumb.x - index.x, thumb.y - index.y);

        if (dist < 0.08) {
            if (!isPinching) {
                // å¼€å§‹æåˆ
                isPinching = true;
                startPinch = { x: index.x, y: index.y };
                initialModel = { ...targetModel }; // è®°å½•å½“å‰çŠ¶æ€
                
                statusPill.innerText = "âœŠ æ‹–æ‹½ï¼šä¸Šä¸‹ç¼©æ”¾ / å·¦å³æ—‹è½¬";
                statusPill.style.color = "#FFD700";
            } else {
                // æ‹–åŠ¨ä¸­
                const deltaX = index.x - startPinch.x;
                const deltaY = index.y - startPinch.y;

                // å·¦å³æ‹–åŠ¨ -> æ—‹è½¬ (deltaX * çµæ•åº¦)
                targetModel.rotateY = initialModel.rotateY + (deltaX * CONFIG.moveSensitivity * 2);

                // ä¸Šä¸‹æ‹–åŠ¨ -> ç¼©æ”¾ 
                // å±å¹•ä¸Šyæ˜¯0ï¼Œä¸‹æ˜¯1ã€‚æ‰‹å¾€ä¸Š(yå˜å°) = æ”¾å¤§ã€‚æ‰€ä»¥æ˜¯ -deltaY
                targetModel.scale = initialModel.scale + (-deltaY * CONFIG.moveSensitivity);
                
                // é™åˆ¶ç¼©æ”¾èŒƒå›´
                targetModel.scale = Math.max(0.2, Math.min(3.0, targetModel.scale));
            }
        } else {
            if (isPinching) {
                isPinching = false;
                statusPill.innerText = "è¯†åˆ«æˆåŠŸï¼ğŸ– æåˆæ‰‹æŒ‡æ§åˆ¶";
                statusPill.style.color = "#00ff88";
                
                // æ¾å¼€æ—¶ï¼ŒåŒæ­¥åˆå§‹çŠ¶æ€ï¼Œé˜²æ­¢ä¸‹æ¬¡ç‚¹å‡»è·³å˜
                initialModel = { ...targetModel };
            }
        }
    }

    // === 4. æ¸²æŸ“å¹³æ»‘å™¨ (å§‹ç»ˆè¿è¡Œ) ===
    AFRAME.registerComponent('smooth-controller', {
        tick: function() {
            if (!isTargetFound) return;

            // Lerp æ’å€¼ç®—æ³•ï¼šè®©è¿åŠ¨å˜å¹³æ»‘ï¼Œè¿‡æ»¤æ‰‹æŠ–
            currentModel.scale += (targetModel.scale - currentModel.scale) * CONFIG.smoothSpeed;
            currentModel.rotateY += (targetModel.rotateY - currentModel.rotateY) * CONFIG.smoothSpeed;

            // åº”ç”¨åˆ° A-Frame å¯¹è±¡
            const mesh = modelWrapper.object3D;
            mesh.scale.set(currentModel.scale, currentModel.scale, currentModel.scale);
            
            // MindAR çš„åæ ‡ç³»ä¸­ï¼Œæ¨¡å‹é€šå¸¸éœ€è¦ç»• Y è½´æˆ– Z è½´æ—‹è½¬ï¼Œè§†å›¾ç‰‡æ–¹å‘è€Œå®š
            // è¿™é‡Œæˆ‘ä»¬è®¾ç½® Y è½´æ—‹è½¬
            mesh.rotation.y = currentModel.rotateY;
        }
    });
    sceneEl.setAttribute('smooth-controller', '');

</script>
</body>
</html>