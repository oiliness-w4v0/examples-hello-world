<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebAR åç½®æ‘„åƒå¤´æ‰‹åŠ¿äº¤äº’</title>
    
    <!-- ä¾èµ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        #container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }

        /* 
           ã€ä¿®æ”¹ç‚¹ 1ã€‘CSS æ ·å¼ 
           åç½®æ‘„åƒå¤´çœ‹åˆ°çš„å¿…é¡»æ˜¯çœŸå®ä¸–ç•Œçš„æ–¹å‘ï¼Œ
           æ‰€ä»¥å»æ‰äº† transform: scaleX(-1)
        */
        video {
            position: absolute;
            width: 100%; height: 100%;
            object-fit: cover;
            /* transform: scaleX(-1);  <-- è¿™ä¸€è¡Œåˆ æ‰äº† */
        }

        #three-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2;
        }

        #ui-layer {
            position: absolute;
            top: 20px; width: 100%;
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }
        
        .status-badge {
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>

<div id="container">
    <video id="input_video" playsinline></video>
    <canvas id="three-canvas"></canvas>
    
    <div id="ui-layer">
        <div id="status-box" class="status-badge">æ­£åœ¨è°ƒç”¨åç½®é•œå¤´...</div>
    </div>
</div>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // === é…ç½® ===
    const CONFIG = {
        cameraZ: 5,
        smoothFactor: 0.1,  // å¹³æ»‘ç³»æ•°
        moveSpeed: 8,       // ç§»åŠ¨èŒƒå›´
        depthScale: 15,     // æ·±åº¦çµæ•åº¦
        pinchThreshold: 0.06
    };

    const videoElement = document.getElementById('input_video');
    const statusBox = document.getElementById('status-box');

    // Three.js å˜é‡
    let scene, camera, renderer, model;
    
    // å¹³æ»‘å¤„ç†
    class Smoother {
        constructor(val, alpha) { this.val = val; this.alpha = alpha; }
        update(target) { 
            this.val = this.val * (1 - this.alpha) + target * this.alpha; 
            return this.val; 
        }
    }
    const sX = new Smoother(0, CONFIG.smoothFactor);
    const sY = new Smoother(0, CONFIG.smoothFactor);
    const sZ = new Smoother(0, CONFIG.smoothFactor);

    let isPinching = false;

    // === 1. åˆå§‹åŒ– 3D åœºæ™¯ ===
    function initThree() {
        scene = new THREE.Scene();
        // å¢åŠ æ›´äº®çš„ç¯å¢ƒå…‰ï¼Œå› ä¸ºçœŸå®ç¯å¢ƒé€šå¸¸æ¯”è¾ƒäº®
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
        scene.add(ambientLight);
        
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(0, 5, 5);
        scene.add(dirLight);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = CONFIG.cameraZ;

        renderer = new THREE.WebGLRenderer({ 
            canvas: document.getElementById('three-canvas'), 
            alpha: true, 
            antialias: true 
        });
        renderer.setSize(window.innerWidth, window.innerHeight);

        // åŠ è½½æ¨¡å‹
        const loader = new GLTFLoader();
        // æ¢äº†ä¸€ä¸ªå®‡èˆªå‘˜æ¨¡å‹ï¼Œæ„Ÿè§‰æ›´é€‚åˆ AR
        const modelUrl = './my-avatar.glb'; 
        
        loader.load(modelUrl, (gltf) => {
            model = gltf.scene;
            model.scale.set(2, 2, 2); 
            model.position.y = -1; // åˆå§‹ä½ç½®æ”¾ä½ä¸€ç‚¹
            scene.add(model);
            statusBox.innerText = "ğŸ– è¯·ä¼¸å‡ºæ‰‹è¿›è¡Œè¯†åˆ«";
            animate();
        }, undefined, () => statusBox.innerText = "æ¨¡å‹åŠ è½½å¤±è´¥");
    }

    function animate() {
        requestAnimationFrame(animate);
        
        // ç®€å•çš„è‡ªè½¬åŠ¨ç”»ï¼Œè®©æ¨¡å‹æ²¡è¢«æ“ä½œæ—¶ä¹Ÿåœ¨åŠ¨
        if (model && !isPinching) {
            model.rotation.y += 0.01;
        }
        
        renderer.render(scene, camera);
    }

    initThree();

    // === 2. MediaPipe å¤„ç† ===
    function onResults(results) {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            const thumb = landmarks[4];
            const index = landmarks[8];
            const wrist = landmarks[0];
            const middleBase = landmarks[9];

            const pinchDist = Math.hypot(thumb.x - index.x, thumb.y - index.y);
            const handSize = Math.hypot(wrist.x - middleBase.x, wrist.y - middleBase.y);

            if (pinchDist < CONFIG.pinchThreshold) {
                isPinching = true;
                statusBox.innerText = "âœŠ æŠ“å–ä¸­";
                statusBox.style.borderColor = "#0f0";

                // ã€ä¿®æ”¹ç‚¹ 3ã€‘åæ ‡æ˜ å°„é€»è¾‘
                // å‰ç½®é•œå¤´æˆ‘ä»¬éœ€è¦ç¿»è½¬X (1 - x)ï¼Œåç½®é•œå¤´ç›´æ¥ç”¨ x å³å¯
                // MediaPipe: å·¦=0, å³=1 -> ThreeJS: å·¦=è´Ÿ, å³=æ­£
                
                let targetX = (index.x - 0.5) * CONFIG.moveSpeed; // å»æ‰äº† 1-index.x
                let targetY = (0.5 - index.y) * (CONFIG.moveSpeed * 0.8);
                
                // æ·±åº¦æ˜ å°„ (Zè½´)
                let targetZ = (handSize - 0.1) * CONFIG.depthScale; 

                // åº”ç”¨å¹³æ»‘
                model.position.set(
                    sX.update(targetX),
                    sY.update(targetY),
                    sZ.update(targetZ)
                );

                // è®©æ¨¡å‹æœå‘é•œå¤´
                model.rotation.set(0, 0, 0); 

            } else {
                isPinching = false;
                statusBox.innerText = "ğŸ– æ¾å¼€çŠ¶æ€";
                statusBox.style.borderColor = "#fff";
            }
        }
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);

    // === 3. å¯åŠ¨æ‘„åƒå¤´ï¼ˆåç½®ï¼‰ ===
    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 1280,
        height: 720,
        // ã€ä¿®æ”¹ç‚¹ 2ã€‘å…³é”®å‚æ•°ï¼šä½¿ç”¨ environment ä»£è¡¨åç½®æ‘„åƒå¤´
        facingMode: "environment" 
    });
    cameraUtils.start();

</script>
</body>
</html>