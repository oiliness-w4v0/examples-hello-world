<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR å±•å° - å®‰å“ä¿®å¤ç‰ˆ</title>

    <!-- 0. å¼•å…¥ vConsole (æ‰‹æœºç«¯è°ƒè¯•ç¥å™¨) -->
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // åˆå§‹åŒ–è°ƒè¯•é¢æ¿ï¼Œå¦‚æœä½ çœ‹åˆ°å±å¹•å³ä¸‹è§’æœ‰ä¸ªç»¿è‰²æŒ‰é’®ï¼Œç‚¹å¼€èƒ½çœ‹æŠ¥é”™
        var vConsole = new VConsole(); 
        console.log("vConsole åˆå§‹åŒ–å®Œæˆ");
    </script>

    <!-- 1. æ ¸å¿ƒåº“ -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        
        /* å¯åŠ¨æŒ‰é’®å±‚ (å¼ºåˆ¶ç”¨æˆ·ç‚¹å‡»ï¼Œè§£å†³å®‰å“è‡ªåŠ¨æ’­æ”¾ç­–ç•¥é—®é¢˜) */
        #start-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        #start-btn {
            padding: 15px 40px; font-size: 20px; color: white; background: #00aaff;
            border: none; border-radius: 50px; margin-top: 20px;
        }

        /* çŠ¶æ€æ¡ */
        #status-bar {
            position: fixed; top: 10px; left: 0; width: 100%; 
            text-align: center; color: yellow; z-index: 100;
            text-shadow: 1px 1px 2px black; pointer-events: none;
        }

        /* è¾…åŠ© Canvasï¼Œè®¾ä¸ºä¸å¯è§ */
        #input-canvas {
            display: none; 
        }
    </style>
</head>
<body>

    <!-- å¯åŠ¨å±‚ -->
    <div id="start-layer">
        <div style="color:white; margin-bottom: 20px;">AR å±•å°äº¤äº’ä½“éªŒ</div>
        <button id="start-btn">ç‚¹å‡»å¼€å§‹ (å®‰å“å¿…ç‚¹)</button>
        <div style="color:#aaa; font-size:12px; margin-top:10px;" id="console-log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <div id="status-bar">å‡†å¤‡ä¸­...</div>

    <!-- ä¸­è½¬ç”¨çš„ Canvas -->
    <canvas id="input-canvas"></canvas>

    <!-- MindAR åœºæ™¯ -->
    <a-scene 
        mindar-image="imageTargetSrc: ./card2.mind; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity id="target-entity" mindar-image-target="targetIndex: 0">
            <a-entity id="model-wrapper" position="0 0 0" scale="0.5 0.5 0.5">
                <a-gltf-model 
                    src="./DamagedHelmet.glb"
                    position="0 0 0" rotation="90 0 0">
                </a-gltf-model>
            </a-entity>
        </a-entity>
    </a-scene>

<script>
    // === å˜é‡å®šä¹‰ ===
    const statusBar = document.getElementById('status-bar');
    const startLayer = document.getElementById('start-layer');
    const startBtn = document.getElementById('start-btn');
    const inputCanvas = document.getElementById('input-canvas');
    const ctx = inputCanvas.getContext('2d');
    const modelWrapper = document.getElementById('model-wrapper');
    const logDiv = document.getElementById('console-log');

    // çŠ¶æ€
    let isStarted = false;
    let isTargetFound = false;
    let isPinching = false;
    
    // å¹³æ»‘å‚æ•°
    let targetScale = 0.5;
    let currentScale = 0.5;
    let startPinchY = 0;
    
    // === 1. ç”¨æˆ·ç‚¹å‡»å¯åŠ¨ (è§£å†³å®‰å“æƒé™é—®é¢˜) ===
    startBtn.addEventListener('click', () => {
        startLayer.style.display = 'none';
        statusBar.innerText = "æ­£åœ¨åˆå§‹åŒ– AR å¼•æ“...";
        isStarted = true;
        // å°è¯•æ’­æ”¾éŸ³é¢‘æˆ–ç©ºè§†é¢‘ä»¥æ¿€æ´»ç¯å¢ƒï¼ˆå¯é€‰ï¼‰
    });

    // === 2. MindAR äº‹ä»¶ ===
    const sceneEl = document.querySelector('a-scene');
    
    sceneEl.addEventListener("arReady", () => {
        console.log("MindAR Ready");
        statusBar.innerText = "AR å°±ç»ªï¼Œæ­£åœ¨åŠ è½½æ‰‹åŠ¿...";
        initMediaPipe();
    });

    sceneEl.addEventListener("arError", (ev) => {
        console.error("AR Error:", ev);
        statusBar.innerText = "AR å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™";
    });

    const targetEntity = document.getElementById('target-entity');
    targetEntity.addEventListener("targetFound", () => {
        console.log("Target Found");
        isTargetFound = true;
        statusBar.innerText = "è¯†åˆ«æˆåŠŸï¼è¯·æŠŠæ‰‹æ”¾åœ¨æ‘„åƒå¤´å‰";
    });
    
    targetEntity.addEventListener("targetLost", () => {
        console.log("Target Lost");
        isTargetFound = false;
        isPinching = false;
        statusBar.innerText = "è¯·æ‰«æå›¾ç‰‡";
    });

    // === 3. MediaPipe åˆå§‹åŒ– ===
    let hands;
    
    function initMediaPipe() {
        try {
            hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0, // å®‰å“å¿…é¡»ç”¨ 0
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onHandResults);
            
            console.log("MediaPipe initialized");
            // å¼€å§‹å¯»æ‰¾è§†é¢‘æµ
            findVideoAndStart();
        } catch (e) {
            console.error("MediaPipe Init Error:", e);
            statusBar.innerText = "AI åˆå§‹åŒ–å¤±è´¥";
        }
    }

    // === 4. [æ ¸å¿ƒä¿®å¤] ä½¿ç”¨ Canvas ä¸­è½¬è§†é¢‘æµ ===
    function findVideoAndStart() {
        const video = document.querySelector('video');
        if (video) {
            console.log("Video element found:", video);
            
            // ç¡®ä¿è§†é¢‘æ­£åœ¨æ’­æ”¾
            video.addEventListener('loadeddata', () => {
                console.log("Video data loaded, size:", video.videoWidth, video.videoHeight);
                startLoop(video);
            });
            
            // å¦‚æœå·²ç»åŠ è½½äº†
            if (video.readyState >= 2) {
                startLoop(video);
            }
        } else {
            console.log("Waiting for video...");
            requestAnimationFrame(findVideoAndStart);
        }
    }

    // å¾ªç¯æ£€æµ‹
    let lastTime = 0;
    const FPS = 15; // é™åˆ¶å¸§ç‡
    const interval = 1000 / FPS;

    function startLoop(video) {
        statusBar.innerText = "ç³»ç»Ÿè¿è¡Œä¸­";
        
        async function loop(timestamp) {
            if (!isStarted) return;

            if (timestamp - lastTime >= interval) {
                lastTime = timestamp;

                // åªæœ‰å½“æœ‰ç”»é¢å°ºå¯¸æ—¶æ‰å¤„ç†
                if (video.videoWidth > 0 && video.videoHeight > 0) {
                    
                    // 1. è®¾ç½®ä¸­è½¬ Canvas å°ºå¯¸ (åªåšä¸€æ¬¡æˆ–å½“å°ºå¯¸å˜åŒ–æ—¶)
                    if (inputCanvas.width !== video.videoWidth) {
                        inputCanvas.width = video.videoWidth;
                        inputCanvas.height = video.videoHeight;
                    }

                    // 2. [å…³é”®æ­¥éª¤] æŠŠè§†é¢‘ç”»åˆ° Canvas ä¸Š
                    // è¿™ä¸€æ­¥è§£è€¦äº† MediaPipe å’Œ MindAR å¯¹ Video çš„äº‰å¤º
                    ctx.drawImage(video, 0, 0, inputCanvas.width, inputCanvas.height);

                    // 3. åªæœ‰å½“è¯†åˆ«å›¾è¢«æ‰¾åˆ°æ—¶ï¼Œæ‰é€å» AI è¯†åˆ« (èŠ‚çœæ€§èƒ½)
                    if (isTargetFound) {
                        try {
                            // å‘é€ Canvas è€Œä¸æ˜¯ Video
                            await hands.send({image: inputCanvas});
                        } catch (err) {
                            console.error("AI Detect Error:", err);
                        }
                    }
                }
            }
            requestAnimationFrame(loop);
        }
        loop(0);
    }

    // === 5. æ‰‹åŠ¿ç»“æœå¤„ç† ===
    function onHandResults(results) {
        // å¦‚æœä½ éœ€è¦è°ƒè¯•ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Šï¼Œåœ¨ vConsole é‡Œçœ‹æ˜¯å¦æœ‰æ•°æ®è¾“å‡º
        // console.log("Hand results:", results.multiHandLandmarks.length);

        if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
            isPinching = false;
            return;
        }

        const lm = results.multiHandLandmarks[0];
        const thumb = lm[4];
        const index = lm[8];

        // ç®€åŒ–çš„è·ç¦»è®¡ç®—
        const dist = Math.sqrt(Math.pow(thumb.x - index.x, 2) + Math.pow(thumb.y - index.y, 2));

        if (dist < 0.08) {
            statusBar.innerText = "âœŠ æåˆä¸­ - ä¸Šä¸‹ç§»åŠ¨ç¼©æ”¾";
            
            if (!isPinching) {
                isPinching = true;
                startPinchY = index.y; // è®°å½•åˆå§‹Y
            } else {
                // è®¡ç®—å·®å€¼
                const deltaY = startPinchY - index.y; // å‘ä¸Šä¸ºæ­£(index.yå˜å°)
                
                // ç¼©æ”¾ç³»æ•°
                const sensitivity = 2.0;
                targetScale = currentScale + (deltaY * sensitivity);
                
                // é™åˆ¶
                targetScale = Math.max(0.2, Math.min(3.0, targetScale));
            }
        } else {
            isPinching = false;
            currentScale = targetScale; // åŒæ­¥çŠ¶æ€
            statusBar.innerText = "ğŸ– å¼ å¼€";
        }
    }

    // === 6. æ¸²æŸ“å¾ªç¯ (A-Frame Tick) ===
    AFRAME.registerComponent('control-loop', {
        tick: function() {
            if (!modelWrapper) return;
            
            // ç®€å•çš„å¹³æ»‘æ’å€¼
            currentScale += (targetScale - currentScale) * 0.1;
            
            modelWrapper.object3D.scale.set(currentScale, currentScale, currentScale);
        }
    });
    sceneEl.setAttribute('control-loop', '');

</script>
</body>
</html>