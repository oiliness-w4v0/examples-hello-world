<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR å±•å° - ç¨³å®šäº¤äº’ç‰ˆ</title>

    <!-- 1. A-Frame & MindAR -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- 2. MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        
        #ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            display: flex; flex-direction: column; align-items: center;
        }

        #status-pill {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        /* æ‰«ææ¡† */
        #scan-box {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 60vw; height: 60vw;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 10px;
        }
        
        /* æ‰«ææ¡†å››è§’ç‰¹æ•ˆ */
        #scan-box::before, #scan-box::after {
            content: ''; position: absolute; width: 20px; height: 20px;
            border-color: #00ff88; border-style: solid;
        }
        #scan-box::before { top: -2px; left: -2px; border-width: 4px 0 0 4px; }
        #scan-box::after { bottom: -2px; right: -2px; border-width: 0 4px 4px 0; }

        .hidden { opacity: 0; transition: opacity 0.5s; }
    </style>
</head>
<body>

    <div id="ui-overlay">
        <div id="status-pill">åˆå§‹åŒ–å¼•æ“...</div>
        <div id="scan-box"></div>
    </div>

    <!-- MindAR åœºæ™¯ -->
    <!-- æ³¨æ„ï¼šuiScanning: no å…³é—­é»˜è®¤UIï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ -->
    <a-scene 
        mindar-image="imageTargetSrc: ./card2.mind; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- è¯†åˆ«ç›®æ ‡ -->
        <a-entity id="target-entity" mindar-image-target="targetIndex: 0">
            <!-- 
                æ¨¡å‹åŒ…è£¹å±‚ 
                scale: åˆå§‹å¤§å°
            -->
            <a-entity id="model-wrapper" position="0 0 0" scale="0.5 0.5 0.5" rotation="0 0 0">
                <a-gltf-model 
                    src="./DamagedHelmet.glb"
                    position="0 0 0"
                    rotation="90 0 0"> <!-- æ ¹æ®æ¨¡å‹è‡ªèº«åæ ‡è½´å¯èƒ½éœ€è¦å¾®è°ƒåˆå§‹è§’åº¦ -->
                </a-gltf-model>
            </a-entity>
        </a-entity>
    </a-scene>

<script>
    // === é…ç½®é¡¹ ===
    const CONFIG = {
        smoothSpeed: 0.1,    // å¹³æ»‘ç³»æ•° (0.01-1.0)ï¼Œè¶Šå°è¶Šç¨³ï¼Œè¶Šå¤§è¶Šå¿«
        rotateSpeed: 3.0,    // æ—‹è½¬çµæ•åº¦
        zoomSpeed: 2.0       // ç¼©æ”¾çµæ•åº¦
    };

    // DOM å¼•ç”¨
    const statusPill = document.getElementById('status-pill');
    const scanBox = document.getElementById('scan-box');
    const targetEntity = document.getElementById('target-entity');
    const modelWrapper = document.getElementById('model-wrapper');
    const sceneEl = document.querySelector('a-scene');

    // çŠ¶æ€å˜é‡
    let isArReady = false;
    let isTargetFound = false;
    
    // äº¤äº’é€»è¾‘å˜é‡
    let isPinching = false;
    let startPinchPos = { x: 0, y: 0 }; // æåˆå¼€å§‹æ—¶çš„æ‰‹éƒ¨åæ ‡
    
    // ç›®æ ‡å€¼ (Target) vs å½“å‰å€¼ (Current) -> ç”¨äºå¹³æ»‘åŠ¨ç”»
    let targetState = {
        scale: 0.5,      // ç›®æ ‡ç¼©æ”¾
        rotationY: 0     // ç›®æ ‡Yè½´æ—‹è½¬
    };
    let currentState = {
        scale: 0.5,
        rotationY: 0
    };

    // ä¿å­˜æŒ‰ä¸‹æ—¶çš„åˆå§‹çŠ¶æ€
    let initialInteractionState = {
        scale: 0.5,
        rotationY: 0
    };

    // === 1. MindAR äº‹ä»¶ç›‘å¬ ===
    sceneEl.addEventListener("arReady", () => {
        isArReady = true;
        statusPill.innerText = "è¯·æ‰«æè¯†åˆ«å›¾";
        setupMediaPipe(); // ARå‡†å¤‡å¥½åå†å¯åŠ¨æ‘„åƒå¤´åˆ†æ
    });

    targetEntity.addEventListener("targetFound", () => {
        isTargetFound = true;
        scanBox.classList.add('hidden');
        statusPill.innerText = "è¯†åˆ«æˆåŠŸï¼ğŸ– æåˆæ‰‹æŒ‡æ§åˆ¶";
        statusPill.style.borderColor = "#00ff88";
    });

    targetEntity.addEventListener("targetLost", () => {
        isTargetFound = false;
        scanBox.classList.remove('hidden');
        statusPill.innerText = "è¯·å¯¹å‡†è¯†åˆ«å›¾";
        statusPill.style.borderColor = "#fff";
        isPinching = false; // ä¸¢å¤±ç›®æ ‡æ—¶é‡ç½®äº¤äº’
    });

    // === 2. æ¸²æŸ“å¾ªç¯ (A-Frame Tick) ===
    // è¿™ä¸€æ­¥æ˜¯â€œç¨³â€çš„å…³é”®ï¼šæ¯ä¸€å¸§éƒ½åœ¨åšå¹³æ»‘æ’å€¼ï¼Œè€Œä¸æ˜¯ç›´æ¥è®¾ç½®
    AFRAME.registerComponent('smooth-controller', {
        tick: function (time, timeDelta) {
            if (!isTargetFound) return;

            // --- æ ¸å¿ƒç®—æ³•ï¼šLerp (çº¿æ€§æ’å€¼) ---
            // å…¬å¼ï¼šå½“å‰å€¼ = å½“å‰å€¼ + (ç›®æ ‡å€¼ - å½“å‰å€¼) * ç³»æ•°
            
            // 1. å¹³æ»‘ç¼©æ”¾
            currentState.scale += (targetState.scale - currentState.scale) * CONFIG.smoothSpeed;
            // é™åˆ¶ä¸€ä¸‹æœ€å°æœ€å¤§ç¼©æ”¾ï¼Œé˜²æ­¢ç¼©æ²¡äº†
            if (currentState.scale < 0.1) currentState.scale = 0.1;
            if (currentState.scale > 3.0) currentState.scale = 3.0;

            // 2. å¹³æ»‘æ—‹è½¬
            currentState.rotationY += (targetState.rotationY - currentState.rotationY) * CONFIG.smoothSpeed;

            // 3. åº”ç”¨åˆ° 3D ç‰©ä½“
            const el = modelWrapper.object3D;
            el.scale.set(currentState.scale, currentState.scale, currentState.scale);
            
            // MindAR çš„ Y è½´é€šå¸¸æ˜¯å‚ç›´äºå›¾ç‰‡çš„ï¼Œè¿™é‡Œæ ¹æ®å®é™…æ¨¡å‹è½´å‘å¯èƒ½éœ€è¦è°ƒæ•´
            // è¿™é‡Œæˆ‘ä»¬æ§åˆ¶ Z è½´æ—‹è½¬(å¹³é¢æ—‹è½¬) æˆ– Y è½´(ç«‹æŸ±æ—‹è½¬)ï¼Œå–å†³äºæ¨¡å‹æœå‘
            el.rotation.y = currentState.rotationY; 
        }
    });
    sceneEl.setAttribute('smooth-controller', '');


    // === 3. MediaPipe é€»è¾‘ ===
    function setupMediaPipe() {
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        
        // é™ä½æ¨¡å‹å¤æ‚åº¦ä»¥æå‡ AR å¸§ç‡
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 0, 
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(handleHandResults);

        // è·å– AR è§†é¢‘æµ
        const video = document.querySelector('video');
        if (video) {
            startPredictionLoop(video, hands);
        }
    }

    async function startPredictionLoop(video, hands) {
        async function step() {
            // åªæœ‰å½“ç›®æ ‡è¢«å‘ç°æ—¶æ‰æ£€æµ‹æ‰‹åŠ¿ï¼ŒèŠ‚çœæ€§èƒ½
            if (isTargetFound && video.readyState >= 2) {
                await hands.send({image: video});
            }
            requestAnimationFrame(step);
        }
        step();
    }

    function handleHandResults(results) {
        if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
            // å¦‚æœæ‰‹ç§»å¼€äº†ï¼Œå–æ¶ˆæåˆçŠ¶æ€
            isPinching = false; 
            return;
        }

        const landmarks = results.multiHandLandmarks[0];
        const thumb = landmarks[4];
        const index = landmarks[8];

        // è®¡ç®—æåˆè·ç¦»
        const pinchDist = Math.hypot(thumb.x - index.x, thumb.y - index.y);
        const threshold = 0.08;

        if (pinchDist < threshold) {
            // === çŠ¶æ€ï¼šæ­£åœ¨æåˆ ===
            
            if (!isPinching) {
                // -> åˆšå¼€å§‹æåˆçš„ä¸€ç¬é—´ (On Pinch Start)
                isPinching = true;
                
                // 1. è®°å½•æ‰‹çš„ä½ç½®
                startPinchPos = { x: index.x, y: index.y };
                
                // 2. è®°å½•æ¨¡å‹å½“å‰çš„çŠ¶æ€
                initialInteractionState.scale = targetState.scale;
                initialInteractionState.rotationY = targetState.rotationY;

                statusPill.innerText = "âœŠ å·²é”å®šï¼šä¸Šä¸‹æ‹–æ‹½=ç¼©æ”¾ï¼Œå·¦å³=æ—‹è½¬";
                statusPill.style.color = "#FFD700";
            } else {
                // -> ä¿æŒæåˆå¹¶ç§»åŠ¨ (On Drag)
                
                // è®¡ç®—åç§»é‡ (Delta)
                // index.x æ˜¯ 0-1 ä¹‹é—´çš„å°æ•°
                const deltaX = index.x - startPinchPos.x; 
                const deltaY = index.y - startPinchPos.y; 

                // --- é€»è¾‘ä¿®æ­£ï¼šå¢é‡æ§åˆ¶ ---
                
                // æ§åˆ¶æ—‹è½¬ (å·¦å³æ‹–åŠ¨)
                // ä¹˜ä»¥ç³»æ•° amplify æ•ˆæœ
                targetState.rotationY = initialInteractionState.rotationY + (deltaX * CONFIG.rotateSpeed);

                // æ§åˆ¶ç¼©æ”¾ (ä¸Šä¸‹æ‹–åŠ¨)
                // æ³¨æ„ï¼šå±å¹•åæ ‡ y å‘ä¸‹æ˜¯å˜å¤§ã€‚
                // æˆ‘ä»¬å¸Œæœ›ï¼šæ‰‹æŒ‡å‘ä¸Šæ¨(yå˜å°) -> å˜å¤§(æ‹‰è¿‘)ï¼›æ‰‹æŒ‡å‘ä¸‹æ‹‰(yå˜å¤§) -> å˜å°(æ¨è¿œ)
                // æ‰€ä»¥æ˜¯ -deltaY
                targetState.scale = initialInteractionState.scale + (deltaY * -1 * CONFIG.zoomSpeed);
            }

        } else {
            // === çŠ¶æ€ï¼šæ¾å¼€ ===
            if (isPinching) {
                isPinching = false;
                statusPill.innerText = "è¯†åˆ«æˆåŠŸï¼ğŸ– æåˆæ‰‹æŒ‡æ§åˆ¶";
                statusPill.style.color = "#FFF";
            }
        }
    }

</script>
</body>
</html>