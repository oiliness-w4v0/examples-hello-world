<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>H5 æ‰‹åŠ¿è¯†åˆ«äº¤äº’</title>
    <!-- å¼•å…¥ MediaPipe Hands æ ·å¼ä¸è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        body {
            margin: 0;
            background-color: #000;
            overflow: hidden;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        /* è§†é¢‘å’Œç”»å¸ƒé‡å  */
        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
            z-index: 1;
        }

        canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
            z-index: 2;
        }

        /* çŠ¶æ€æ˜¾ç¤ºé¢æ¿ */
        #status-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px 30px;
            border-radius: 30px;
            color: white;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        #gesture-result {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }
        
        #debug-info {
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }

        .loading {
            position: absolute;
            z-index: 4;
            color: white;
            font-size: 18px;
            top: 50%;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- è§†é¢‘æºï¼Œéšè—æ˜¾ç¤ºï¼Œä½†ç”¨äºé‡‡é›† -->
        <video id="input_video" playsinline></video>
        <!-- ç»˜åˆ¶æ‰‹éƒ¨éª¨éª¼çš„ç”»å¸ƒ -->
        <canvas id="output_canvas"></canvas>
        
        <!-- UI å±•ç¤º -->
        <div id="status-box">
            <div>å½“å‰æ‰‹åŠ¿</div>
            <div id="gesture-result">ç­‰å¾…æ‰‹éƒ¨...</div>
            <div id="debug-info">è·ç¦»: 0</div>
        </div>
        
        <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ¨¡å‹ï¼Œè¯·ç¨å€™...</div>
    </div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const resultText = document.getElementById('gesture-result');
    const debugText = document.getElementById('debug-info');
    const loadingText = document.getElementById('loading');

    // è°ƒæ•´ Canvas å°ºå¯¸ä»¥åŒ¹é…å±å¹•
    function resizeCanvas() {
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // å…³é”®ç‚¹ç´¢å¼•
    // 4: å¤§æ‹‡æŒ‡æŒ‡å°– (Thumb_Tip)
    // 8: é£ŸæŒ‡æŒ‡å°– (Index_Finger_Tip)
    const THUMB_TIP = 4;
    const INDEX_FINGER_TIP = 8;

    /**
     * è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„æ¬§å‡ é‡Œå¾—è·ç¦»
     */
    function calculateDistance(p1, p2) {
        return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    }

    function onResults(results) {
        loadingText.style.display = 'none';
        
        // æ¸…ç©ºç”»å¸ƒ
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        
        // å¦‚æœæ£€æµ‹åˆ°äº†æ‰‹
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            for (const landmarks of results.multiHandLandmarks) {
                // 1. ç»˜åˆ¶éª¨éª¼è¿çº¿
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS,
                               {color: '#00FF00', lineWidth: 2});
                // 2. ç»˜åˆ¶å…³é”®ç‚¹
                drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 3});

                // 3. è¯†åˆ«é€»è¾‘
                const thumbTip = landmarks[THUMB_TIP];
                const indexTip = landmarks[INDEX_FINGER_TIP];

                // è®¡ç®—æ‹‡æŒ‡å’Œé£ŸæŒ‡æŒ‡å°–çš„è·ç¦» (åæ ‡æ˜¯å½’ä¸€åŒ–çš„ 0.0 - 1.0)
                const distance = calculateDistance(thumbTip, indexTip);
                
                // æ˜¾ç¤ºè°ƒè¯•æ•°æ®
                debugText.innerText = `æŒ‡å°–è·ç¦»: ${distance.toFixed(3)}`;

                // é˜ˆå€¼åˆ¤æ–­
                // è·ç¦»å°äº 0.08 è®¤ä¸ºæ˜¯æåˆ (æ ¹æ®å®é™…ä½“éªŒå¾®è°ƒ)
                // è·ç¦»å¤§äº 0.15 è®¤ä¸ºæ˜¯å¼ å¼€
                if (distance < 0.08) {
                    resultText.innerText = "âœŠ æåˆ (Pinch)";
                    resultText.style.color = "#ffdd00";
                    
                    // å¯åœ¨æ­¤å¤„è§¦å‘äº¤äº’ï¼Œä¾‹å¦‚æ‹–æ‹½å…ƒç´ 
                    
                } else if (distance > 0.15) {
                    resultText.innerText = "ğŸ– å¼ å¼€ (Open)";
                    resultText.style.color = "#00ff88";
                } else {
                    resultText.innerText = "å‡†å¤‡ä¸­...";
                    resultText.style.color = "#ffffff";
                }
            }
        } else {
            resultText.innerText = "æœªæ£€æµ‹åˆ°æ‰‹éƒ¨";
            resultText.style.color = "#ccc";
            debugText.innerText = "";
        }
        canvasCtx.restore();
    }

    // åˆå§‹åŒ– MediaPipe Hands
    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});

    hands.setOptions({
        maxNumHands: 1,             // æœ€å¤šæ£€æµ‹ä¸€åªæ‰‹
        modelComplexity: 1,         // æ¨¡å‹å¤æ‚åº¦ï¼š0(æ€§èƒ½å¥½), 1(å¹³è¡¡)
        minDetectionConfidence: 0.5,// æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼
        minTrackingConfidence: 0.5  // è¿½è¸ªç½®ä¿¡åº¦é˜ˆå€¼
    });

    hands.onResults(onResults);

    // å¯åŠ¨æ‘„åƒå¤´
    const camera = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({image: videoElement});
        },
        width: 1280,
        height: 720,
        facingMode: "user" // ä½¿ç”¨å‰ç½®æ‘„åƒå¤´
    });
    
    camera.start().catch(err => {
        console.error(err);
        loadingText.innerText = "æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–HTTPSç¯å¢ƒ";
    });
</script>
</body>
</html>